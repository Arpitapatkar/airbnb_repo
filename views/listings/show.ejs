<% layout("layouts/boilerplate") %>
<body>

    <div class="row mt-3">
        <div class="col-8 offset-3">

    <h3><%= listing.title %></h3>
    </div>

    <div class="card col-6 offset-3 show-card listing-card">
        <img 
            src="<%=listing.image.url.replace("/upload/" , "/upload/f_auto,q_auto,w_800,c_fill/") %>" 
            class="card-img-top show-img " 
            alt="listing_image"
            style= "object-fit:cover; width:80%;"
            />
     <div class="card-body">
       <p class="card-text">Owned by : <i><%=listing.owner.username%></i></p>
          <p class="card-text"> <%= listing.description %></p>
          <p class="card-text">&#8377;<%= listing.price.toLocaleString("en-IN")%></p>
          <p class="card-text"><%= listing.location %></p>
         <p class="card-text"> <%= listing.country %></p>
      </div>
    </div>
    </div>

   <% if(currUser && listing.owner._id.equals(currUser._id)){ %>
    <div class="btns">
       <a 
       href="/listings/<%=listing._id %>/edit" 
       class="btn  btn-dark col-1 offset-3 edit-btn">Edit</a>

      <form method="POST" action="/listings/<%=listing._id%>?_method=DELETE">
        <button class="btn btn-dark offset-5">Delete</button>
      </form>
    </div>
<%}%>
    
    <!-- review -->
    
    <div class="col-8 offset-3 mb-3" >
      
      <% if(currUser) { %>
        <hr/>
      <h4>Review</h4>
      <form 
             action="/listings/<%= listing.id %>/reviews" 
             method="POST" 
             novalidate class="needs-validation">

         <!-- <div class="mb-3 mt-3">
          <label for="rating" class="form-label">Rating</label>
          <input 
          type="range" 
          min="1" 
          max="5" 
          id="rating" 
          name="review[rating]" 
          class="form-range"
          />
         </div> -->

         <div class="mb-3 mt-3">
          <label for="rating" class="form-label ">Rating</label>
        <fieldset class="starability-growRotate ">
  <input 
        type="radio" 
        id="no-rate" 
        class="input-no-rate" 
        name="review[rating]" 
        value="1" 
        checked aria-label="No rating." />
  <input type="radio" id="first-rate1" name="review[rating]" value="1" />
  <label for="first-rate1" title="Terrible">1 star</label>
  <input type="radio" id="first-rate2" name="review[rating]" value="2" />
  <label for="first-rate2" title="Not good">2 stars</label>
  <input type="radio" id="first-rate3" name="review[rating]" value="3" />
  <label for="first-rate3" title="Average">3 stars</label>
  <input type="radio" id="first-rate4" name="review[rating]" value="4" />
  <label for="first-rate4" title="Very good">4 stars</label>
  <input type="radio" id="first-rate5" name="review[rating]" value="5" />
  <label for="first-rate5" title="Amazing">5 stars</label>
</fieldset>
</div>

         <div class="mb-3 mt-3">
          <label for="comment" class="form-label">Comment</label>
          <textarea 
            id="comment" 
            name="review[comment]" 
            cols="30" 
            rows="6" 
            class="form-control"
            required
            ></textarea>
            <div class="invalid-feedback">Please enter comments for review</div>
         </div>
         <button type="submit" class="btn btn-outline-dark">Submit</button>
      </form>
<%}%>
      <hr>

  
    <% if(listing.reviews.length > 0) { %>
       <p><b>All Reviews</b></p>
    <div class="row ">
    <% for(let review of listing.reviews) { %>
          <div class="card col-5 mb-3 ms-3">
            <div class="card-body">
              <h5 class="card-title">@<%= review.author.username %></h5>
               <p class="starability-result responsive-stars" data-rating="<%=review.rating %>"></p>
              <p class="card-text"><%=review.comment %></p>
            </div>
            <form class="mb-3 mt-2" method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
              <button class="btn btn-sm btn-dark">Delete</button>
            </form>
          </div>     
      <% } %>
    </div>
    <% } %>
  </div>

    <div class="col-8 offset-3 mb-3 map-container">
      <h3>Where you'll be</h3>
      <div id="map"></div>
    </div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
</script>

<script>
  document.addEventListener("DOMContentLoaded", async function () {
    const location = "<%= listing.location %>"; 
    const mapElement = document.getElementById("map");

    try {
      // Nominatim API for getting lat/lng
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`
      );
      const data = await response.json();

      if (data && data.length > 0) {
        const lat = data[0].lat;
        const lon = data[0].lon;

        // Initialize Map
        const map = L.map("map").setView([lat, lon], 13);

        // Tile Layer
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        }).addTo(map);

        // Marker
        L.marker([lat, lon])
          .addTo(map)
          .bindPopup(`<b><%= listing.title %></b><br>${location}`)
          .openPopup();
      } else {
        mapElement.innerHTML = "<p class='map-error'>Location not found</p>";
      }
    } catch (error) {
      console.error(error);
      mapElement.innerHTML = "<p class='map-error'>Error loading map</p>";
    }
  });
</script>
  
</body>
